$choco = "https://chocolatey.org/install.ps1"

#$7zip = "http://www.7-zip.org/a/7z1604-x64.msi"
#$git = "https://github.com/git-for-windows/git/releases/download/v2.14.1.windows.1/Git-2.14.1-64-bit.exe"
#$npp = "https://notepad-plus-plus.org/repository/7.x/7.5.4/npp.7.5.4.Installer.x64.exe"
#$ipscan = "http://download.advanced-ip-scanner.com/download/files/Advanced_IP_Scanner_2.5.3850.exe"
# $rsat = "https://download.microsoft.com/download/1/D/8/1D8B5022-5477-4B9A-8104-6A71FF9D98AB/WindowsTH-RSAT_WS2016-x64.msu"

$githubs = "https://github.com/PowerShellMafia/PowerSploit.git",
	"https://github.com/LordNem/ADTools.git",
	"https://github.com/BloodHoundAD/BloodHound.git"

$features = "TelnetClient", 
	"Microsoft-Windows-Subsystem-Linux",
	"NetFx3"

######
Import-Module BitsTransfer

# Directories
mkdir c:\install\ -erroraction silentlycontinue
mkdir c:\pentest\ -erroraction silentlycontinue

# disable defender
Set-MpPreference -DisableRealtimeMonitoring $true

# Chocolatey
write-host "Installing Chocolatey"
(New-Object System.Net.WebClient).DownloadFile( $choco, "c:\install\choco.ps1" )
$env:chocolateyUseWindowsCompression = 'true'
& c:\install\choco.ps1


# 7-zip
write-host "Installing 7-zip"
choco install 7zip -y

# Notepad ++
write-host "Installing Notepad++"
choco install notepadplusplus -y

# Advanced IP Scanner
write-host "Installing Advanced IP Scanner"
choco install advanced-ip-scanner -y

# Chrome
write-host "Installing chrome"
choco install googlechrome -y

# git
write-host "Installing git"
choco install git -y

# Git Repos
$githubs | % {
	cd \pentest
	write-host "Cloning $_"
	Start-Process 'C:\Program Files\Git\bin\git.exe' -ArgumentList "clone $_" -nonewwindow -wait
}

# Features
$features | % {
	write-host "Installing $_"
	Enable-WindowsOptionalFeature -online -featurename $_ -norestart -All
}

# Defender Exclusions
# note, disabling Defender via Set-MpPreference doesn't seem to persist
write-host "Configuring Defender"
Set-MpPreference -ExclusionPath "c:\pentest"

# Developer mode
write-host "Enabling Developer mode"
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock" /t REG_DWORD /f /v "AllowDevelopmentWithoutDevLicense" /d "1"
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock" /t REG_DWORD /f /v "AllowAllTrustedApps" /d "1"

# RSAT
write-host "Installing RSAT"
choco install rsat -y

# create the reg key to execute the first_logon script on first "real" logon
start-process "c:\windows\system32\reg.exe" -ArgumentList "add HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce /f /v lxrun /d 'C:\install\first_logon.bat'" -nonewwindow

# disable fast startup
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Power" /V HiberbootEnabled /T REG_dWORD /D 0 /F

write-host "Installs completed"
