$7zip = "http://www.7-zip.org/a/7z1604-x64.msi"
$git = "https://github.com/git-for-windows/git/releases/download/v2.14.1.windows.1/Git-2.14.1-64-bit.exe"
$ipscan = "https://www.advanced-ip-scanner.com/download.php?lng=en"
$rsat = "https://download.microsoft.com/download/1/D/8/1D8B5022-5477-4B9A-8104-6A71FF9D98AB/WindowsTH-RSAT_WS2016-x64.msu"
$npp = "https://notepad-plus-plus.org/repository/7.x/7.5.4/npp.7.5.4.Installer.x64.exe"

$githubs = "https://github.com/PowerShellMafia/PowerSploit.git",
	"https://github.com/LordNem/ADTools.git",
	"https://github.com/BloodHoundAD/BloodHound.git"

$features = "TelnetClient", 
	"Microsoft-Windows-Subsystem-Linux"

######
Import-Module BitsTransfer

# Directories
mkdir c:\install\ -erroraction silentlycontinue
mkdir c:\pentest\ -erroraction silentlycontinue

# disable defender
Set-MpPreference -DisableRealtimeMonitoring $true

# 7-zip
write-host "Installing 7-zip"
(New-Object System.Net.WebClient).DownloadFile( $7zip, "c:\install\7-zip.msi" )
start-process "msiexec" -argumentlist "/qb /i c:\install\7-zip.msi" -wait

# Notepad ++
write-host "Installing Notepad++"
(New-Object System.Net.WebClient).DownloadFile( $npp, "c:\install\npp.exe" )
start-process "c:\install\npp.exe" -argumentlist "/S" -wait

# Advanced IP Scanner
write-host "Installing Advanced IP Scanner"
(New-Object System.Net.WebClient).DownloadFile( $ipscan, "C:\install\advipscan.exe" )
# No -Wait on this one, because the app launches at the end of the install :( It's pretty quick tho.
Start-Process "c:\install\advipscan.exe" -ArgumentList "/verysilent /norestart"
# kill it once it's done tho!
while ( ( get-process -name advanced_ip_scanner -ea SilentlyContinue ) -eq $null ) { Start-Sleep -s 1; "." } 
stop-process -name advanced_ip_scanner

# git
write-host "Installing git"
(New-Object System.Net.WebClient).DownloadFile( $git, "c:\install\git.exe" )
start-process "c:\install\git.exe" -argumentlist "/silent" -wait

# Git Repos
$githubs | % {
	cd \pentest
	write-host "Cloning $_"
	Start-Process 'C:\Program Files\Git\bin\git.exe' -ArgumentList "clone $_" -nonewwindow -wait
}

# Features
$features | % {
	write-host "Installing $_"
	Enable-WindowsOptionalFeature -online -featurename $_ -norestart
}

# Defender Exclusions
# note, disabling Defender via Set-MpPreference doesn't seem to persist
write-host "Configuring Defender"
Set-MpPreference -ExclusionPath "c:\pentest"

# Developer mode
write-host "Enabling Developer mode"
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock" /t REG_DWORD /f /v "AllowDevelopmentWithoutDevLicense" /d "1"
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\AppModelUnlock" /t REG_DWORD /f /v "AllowAllTrustedApps" /d "1"

# RSAT
write-host "Installing RSAT"
(New-Object System.Net.WebClient).DownloadFile( $rsat, "C:\install\rsat.msu" )
Start-Process "C:\install\rsat.msu" -ArgumentList "/quiet /norestart" -wait

# create the reg key to execute the first_logon script on first "real" logon
start-process "c:\windows\system32\reg.exe" -ArgumentList "add HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce /f /v lxrun /d 'C:\install\first_logon.bat'"

write-host "Installs completed"
